# Inform Note Agent 아키텍처

## 전체 시스템 흐름

```
┌─────────────────┐
│   사용자 질문    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Dify 워크플로우 │
│  (AI 처리)      │
└────────┬────────┘
         │
         │ HTTP Request 노드
         │ POST /ask
         ▼
┌─────────────────────────────────┐
│   백엔드 서버 (FastAPI)          │
│   /ask 엔드포인트                │
└────────┬────────────────────────┘
         │
         │ 질문 분석
         ▼
┌─────────────────────────────────┐
│  Question Analyzer               │
│  - 공정정보 추출                 │
│  - 특정 가능 여부 판단           │
└────────┬────────────────────────┘
         │
         ├─ 특정 가능 ──────────┐
         │                      │
         │                      ▼
         │            ┌──────────────────────┐
         │            │ Process Query Builder│
         │            │ - SQL 쿼리 생성      │
         │            └──────────┬───────────┘
         │                      │
         │                      ▼
         │            ┌──────────────────────┐
         │            │  Oracle Database     │
         │            │  INFORMNOTE_TABLE    │
         │            └──────────┬───────────┘
         │                      │
         │                      │ 결과 반환
         │                      ▼
         │            ┌──────────────────────┐
         │            │  답변 포맷팅         │
         │            │  (통계 + 상세 정보)   │
         │            └──────────┬───────────┘
         │                      │
         │ 특정 불가 ────────────┼───────────┐
         │                      │           │
         │                      ▼           ▼
         │            ┌──────────────────────┐
         │            │  Dify API 호출        │
         │            │  (선택사항)           │
         │            └──────────┬───────────┘
         │                      │
         │                      ▼
         └──────────────────────┘
                      │
                      ▼
         ┌──────────────────────┐
         │  AnswerResponse       │
         │  - answer             │
         │  - question           │
         │  - success            │
         │  - process_specific    │
         │  - data_count         │
         └──────────┬────────────┘
                    │
                    │ JSON 응답
                    ▼
         ┌──────────────────────┐
         │  Dify 워크플로우      │
         │  (최종 답변 생성)     │
         └──────────┬────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │  사용자에게 답변 전달 │
         └──────────────────────┘
```

## 주요 컴포넌트

### 1. Dify 워크플로우
- **역할**: 사용자 질문 수신 및 최종 답변 생성
- **HTTP Request 노드**: 백엔드 서버 호출
- **입력**: `question` (필수), `context` (선택)
- **출력**: `answer` 필드를 사용하여 최종 답변 생성

### 2. 백엔드 서버 (FastAPI)
- **엔드포인트**: `POST /ask`
- **역할**: 
  - 질문 분석 및 공정정보 추출
  - Oracle DB 쿼리 실행
  - 결과 포맷팅 및 반환

### 3. Question Analyzer
- **역할**: 사용자 질문에서 공정정보 추출
- **추출 정보**:
  - `site_id`: 사이트 ID (ICH, CJU, WUX 등)
  - `factory_id`: 공장 ID (FAB1, FAB2 등)
  - `process_id`: 공정 ID (PHOTO, ETCH 등)
  - `model_id`: 모델 ID
  - `down_type`: 다운타임 유형 (SCHEDULED/UNSCHEDULED)
  - `down_time_minutes`: 다운타임 시간 (분)

### 4. Process Query Builder
- **역할**: 추출된 공정정보로 Oracle DB 쿼리 생성 및 실행
- **기능**:
  - 동적 WHERE 절 생성
  - 통계 정보 조회
  - 결과 제한 및 포맷팅

### 5. Oracle Database
- **테이블**: `INFORMNOTE_TABLE`
- **역할**: 반도체 공정 다운타임 데이터 저장 및 조회

## 처리 흐름 상세

### 케이스 1: 공정정보 특정 가능

1. **질문 예시**: "ICH 사이트의 FAB1에서 PHOTO 공정 다운타임 알려줘"
2. **처리 과정**:
   ```
   질문 분석 → site_id: ICH, factory_id: FAB1, process_id: PHOTO 추출
   → SQL 쿼리 생성 및 실행
   → 결과 포맷팅 (통계 + 상세 정보)
   → Dify로 반환
   ```
3. **응답 예시**:
   ```json
   {
     "answer": "다운타임 정보 조회 결과\n[통계 정보]\n- 총 건수: 15건\n...",
     "question": "ICH 사이트의 FAB1에서 PHOTO 공정 다운타임 알려줘",
     "success": true,
     "process_specific": true,
     "data_count": 15
   }
   ```

### 케이스 2: 공정정보 특정 불가능

1. **질문 예시**: "반도체 공정이 뭐야?"
2. **처리 과정**:
   ```
   질문 분석 → 공정정보 추출 실패
   → Dify API 호출 (설정된 경우)
   → 기본 답변 생성
   → Dify로 반환
   ```
3. **응답 예시**:
   ```json
   {
     "answer": "질문을 받았습니다: '반도체 공정이 뭐야?'\n\n공정정보를 특정할 수 없는...",
     "question": "반도체 공정이 뭐야?",
     "success": true,
     "process_specific": false,
     "data_count": null
   }
   ```

## API 스펙

### POST /ask

**Request:**
```json
{
  "question": "ICH 사이트의 FAB1에서 PHOTO 공정 다운타임 알려줘",
  "context": "추가 컨텍스트 (선택사항)"
}
```

**Response:**
```json
{
  "answer": "답변 내용",
  "question": "원본 질문",
  "success": true,
  "process_specific": true,
  "data_count": 15
}
```

**필드 설명:**
- `answer`: Dify 워크플로우에서 사용할 답변 (필수)
- `question`: 원본 질문
- `success`: 처리 성공 여부
- `process_specific`: 공정정보 특정 가능 여부
- `data_count`: 조회된 데이터 건수 (공정정보 특정 가능한 경우)

## 에러 처리

### 데이터베이스 연결 실패
```json
{
  "answer": "데이터베이스에 연결할 수 없습니다. 시스템 관리자에게 문의하세요.",
  "success": false
}
```

### 쿼리 실행 오류
```json
{
  "answer": "공정정보 기반 답변 생성 중 오류가 발생했습니다: ...",
  "success": false
}
```

### 일반 오류
```json
{
  "answer": "질문을 처리하는 중 오류가 발생했습니다: ...",
  "success": false
}
```

## 성능 최적화

1. **쿼리 결과 제한**: 최대 50건으로 제한
2. **인덱스 활용**: 사이트, 공장, 라인, 장비별 인덱스 사용
3. **Dify 요약**: 20건 이상인 경우 Dify API로 요약 요청 (선택사항)
4. **로깅**: 상세한 로깅으로 디버깅 용이

## 보안 고려사항

1. **SQL Injection 방지**: 바인드 파라미터 사용
2. **입력 검증**: 질문 필수 검증
3. **에러 메시지**: 상세한 에러 정보는 로그에만 기록
4. **CORS**: 프로덕션에서는 특정 도메인으로 제한 권장

## 확장 가능성

1. **추가 필터**: 라인 ID, 장비 ID 등 추가 필터 지원 가능
2. **복잡한 쿼리**: 통계 쿼리, 집계 쿼리 등 확장 가능
3. **캐싱**: 자주 조회되는 데이터 캐싱 가능
4. **실시간 알림**: WebSocket을 통한 실시간 업데이트 가능

